<html>

<head>
  <title>Calculator</title>
  <meta charset="UTF-8">
  <meta name="description" content="Payment calculator/printer">
  <meta name="keywords" content="loan,calculator,amortization calculator,interest">
  <meta name="author" content="Dave Danner">
  <link rel="stylesheet" href="css/style.css">
  <!-- <link rel="stylesheet" href="css/bootstrap.min.css"> -->
</head>

<body>
  <script src="js/calculator.js"></script>
  <script>
    window.onload = function() {
      document.getElementById('startDate').valueAsDate = new Date();
      const form = document.querySelector('form')
      form.noValidate = true
      const inputs = document.querySelectorAll("input, text");
      inputs.forEach(input => {
        input.addEventListener("keyup", function() {
          var element = document.getElementById(input.id + 'warn');
          if (element == null) {
            return;
          }
          if (input.checkValidity()) {
            element.style.visibility = "hidden";
          } else {
            element.style.visibility = "visible";
          }
        });

        input.addEventListener("blur", function() {
          checkAndBuildAmortization();
        });
      });
    }

    function createTD(text, tableRow, hideIfSmall) {
      var td = document.createElement("td");
      if (hideIfSmall){
        td.className="small-screen";
      }
      var text = document.createTextNode(text);
      td.append(text);
      tableRow.append(td);
    }

    function buildLoan() {
      var loanAmount = document.getElementById("loanAmount");
      var interestRate = document.getElementById("interestRate");
      var numberOfPayments = document.getElementById("numberOfPayments");
      var startDate = document.getElementById("startDate");
      var loan = new Object();
      loan.amount = loanAmount.value;
      loan.interest = interestRate.value;
      loan.payments = numberOfPayments.value;
      loan.startDate = startDate.valueAsDate;
      if (loan.startDate == null) {
        loan.startDate = new Date();
        startDate.valueAsDate = loan.startDate;
      }
      loan.startDate = addMonthsUTC(loan.startDate, 1);
      return loan;
    }

    function checkAndBuildAmortization() {

      var loanItem = document.getElementById("loanItem");
      var summaryElement = document.getElementById("summaryInfo");
      var amortDiv = document.getElementById("amortDiv");
      var tableBody = document.getElementById("tableBody");
      var loanAmount = document.getElementById("loanAmount");
      var interestRate = document.getElementById("interestRate");
      tableBody.innerHTML = "";
      if (loanAmount.checkValidity() && loanAmount.value.length > 0 && interestRate.checkValidity() && interestRate.value.length > 0 && numberOfPayments.checkValidity() && numberOfPayments.value.length > 0) {
        amortDiv.style.visibility = "visible";
        var paymentData = calculate(buildLoan());

        paymentData.payments.forEach(payment => {
          var tr = document.createElement("tr");
          createTD(payment.paymentNumber, tr, false);
          createTD(formatDollar(payment.beginningBalance), tr, false);
          createTD(formatDollar(payment.amount), tr, false);
          createTD(formatDollar(payment.principal), tr, false);
          createTD(formatDollar(payment.interest), tr, false);
          createTD(formatDollar(payment.totalInterest), tr, true);
          createTD(formatDollar(payment.balance), tr, true);
          createTD(payment.dueDate.toLocaleDateString(undefined), tr);
          tableBody.append(tr);
        });


        var summaryString = "";
        if (loanItem.value != null && loanItem.value.length > 0) {
          summaryString += loanItem.value + "<br\>";
        }

        summaryString += "Monthly Payment: " + formatDollar(paymentData.payment.amount) + ", Total Interest: " + formatDollar(paymentData.payment.interest) + ".";
        summaryString += "<br/><span class='print-only'>Loan Amount: " + formatDollar(parseInt(loanAmount.value, 10)) + ", Interest Rate: " + interestRate.value + "%.</span>";
        summaryElement.innerHTML = summaryString;
      } else {
        amortDiv.style.visiblity = "hidden";
        summaryElement.innerHTML = "";
      }
    }
  </script>
  <div>
    <h2 class="no-print">Loan Calculator</h2>
    <form>
      <table class="table no-print">
        <tbody>
          <tr>
            <td>
              <label>Loan Amount</label>
              <input class="form-controlbs" maxlength="8" minlength="1" name="loanAmount" id="loanAmount" pattern="[0-9.]{1,9}" placeholder="Loan Amount" onblur="this.checkValidity();" type="text" title="Loan Amount is required and must be numeric.">
              <div id="loanAmountwarn" style="visibility:hidden;">
                <small class="text-dangerbs">
                  Loan Amount is required and must be numeric.
                </small>
              </div>
            </td>
            <td>
              <label> Interest Rate %</label>
              <input class="form-controlbs" maxlength="3" minlength="1" id="interestRate" name="interestRate" pattern="[0-9.]{1,4}" placeholder="Interest Rate %" type="text">
              <div id="interestRatewarn" style="visibility:hidden;">
                <small class="text-dangerbs">
                  Interest Rate is required and must be numeric.
                </small>
              </div>
            </td>
          </tr>
          <tr>
            <td>
              <label>Loan Term</label>
              <input class="form-controlbs" maxlength="3" minlength="1" id="numberOfPayments" name="numberOfPayments" pattern="[0-9]{1,3}" placeholder="Number Of Payments" type="text">
              <div id="numberOfPaymentswarn" style="visibility:hidden;">
                <small class="text-dangerbs">
                  Number of payments/Term is required and must be numeric.
                </small>
              </div>
            </td>
            <td>
              <label>Start Date</label>
              <input class="form-controlbs" id="startDate" name="startDate" type="date">
            </td>
          </tr>
          <tr>
            <td colspan="2">
              <label>Loan item</label>
              <input class="form-controlbs" id="loanItem" name="loanItem" placeholder="Optional comment for print out.">
            </td>
          </tr>
        </tbody>
      </table>
      <div id="amortDiv" style="visibility:hidden;">
        <h4 class="text-info text-center" id="summaryInfo">
        </h4>
        <table id="amortTable" class="table table-bordered table-condensed table-striped" width="100%">
          <thead>
            <tr>
              <th>#</th>
              <th>Balance</th>
              <th>Payment</th>
              <th>Principal</th>
              <th>Interest</th>
              <th class="small-screen">Total Interest</th>
              <th class="small-screen">End Balance</th>
              <th>Due Date</th>
            </tr>
          </thead>
          <tbody id="tableBody">
          </tbody>
        </table>
      </div>
    </form>
  </div>
</body>

</html>
